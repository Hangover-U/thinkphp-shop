{extend name="layout/base" /} {block name="title"}è´­ç‰©è½¦ - åœ¨çº¿è´­ç‰©ç³»ç»Ÿ{/block}
{block name="content"}
<div class="container">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb p-3 neomorphic-card mb-4">
      <li class="breadcrumb-item">
        <a href="/" class="text-decoration-none">é¦–é¡µ</a>
      </li>
      <li class="breadcrumb-item active gradient-text" aria-current="page">
        è´­ç‰©è½¦
      </li>
    </ol>
  </nav>

  <h2 class="mb-4 gradient-heading">æˆ‘çš„è´­ç‰©è½¦</h2>

  {if condition="empty($cartItems)"}
  <div class="neomorphic-card p-4 text-center">
    <div class="empty-state">
      <i class="empty-icon">ğŸ›’</i>
      <h4 class="mt-3 mb-3 gradient-heading">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</h4>
      <p class="text-muted">æ‚¨çš„è´­ç‰©è½¦ä¸­è¿˜æ²¡æœ‰å•†å“ï¼Œå¿«å»é€‰è´­å§ï¼</p>
      <a href="/products" class="neomorphic-btn mt-3">å»è´­ç‰©</a>
    </div>
  </div>
  {else}
  <div class="neomorphic-card p-4">
    <div class="table-responsive cart-table-container">
      <table class="table cart-table">
        <thead>
          <tr class="cart-header">
            <th>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="selectAll"
                  checked
                />
                <label class="form-check-label" for="selectAll">å…¨é€‰</label>
              </div>
            </th>
            <th>å•†å“</th>
            <th>å•ä»·</th>
            <th>æ•°é‡</th>
            <th>å°è®¡</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {volist name="cartItems" id="item"}
          <tr class="cart-item neomorphic-item" data-id="{$item.id}">
            <td>
              <div class="form-check">
                <input class="form-check-input item-select" type="checkbox" {if
                $item.selected == 1}checked{/if}>
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="cart-img-container">
                  <img
                    src="{$item.product.image}"
                    alt="{$item.product.name}"
                    class="cart-product-img"
                  />
                </div>
                <div class="ms-3">
                  <h5>
                    <a
                      href="/product/{$item.product.id}"
                      class="cart-product-name"
                      >{$item.product.name}</a
                    >
                  </h5>
                </div>
              </div>
            </td>
            <td class="price gradient-price">ï¿¥{$item.product.price}</td>
            <td>
              <div class="quantity-control">
                <button class="quantity-btn decrease" type="button">-</button>
                <input
                  type="number"
                  class="quantity-input"
                  value="{$item.quantity}"
                  min="1"
                  max="{$item.product.stock}"
                />
                <button class="quantity-btn increase" type="button">+</button>
              </div>
            </td>
            <td class="subtotal gradient-price">
              ï¿¥{$item.product.price * $item.quantity}
            </td>
            <td>
              <button class="btn-delete remove-item">
                <i class="delete-icon">Ã—</i>
              </button>
            </td>
          </tr>
          {/volist}
        </tbody>
      </table>
    </div>

    <div
      class="d-flex flex-wrap justify-content-between align-items-center mt-4 checkout-area"
    >
      <div>
        <button class="neomorphic-btn btn-outline-danger" id="clearCart">
          <i class="trash-icon">ğŸ—‘ï¸</i> æ¸…ç©ºè´­ç‰©è½¦
        </button>
      </div>
      <div class="text-end checkout-total">
        <p class="fs-4 total-amount">
          æ€»è®¡ï¼š<span class="gradient-total-price" id="totalAmount"
            >ï¿¥{$totalAmount}</span
          >
        </p>
        <button class="neomorphic-btn btn-lg checkout-btn" id="checkout">
          <i class="checkout-icon">ğŸ’³</i> ç»“ç®—
        </button>
      </div>
    </div>
  </div>
  {/if}
</div>
{/block} {block name="css"}
<style>
  /* æ¸å˜æ ‡é¢˜ */
  .gradient-heading {
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* æ¸å˜æ–‡å­— */
  .gradient-text {
    font-weight: 600;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* é¢åŒ…å±‘ */
  .breadcrumb {
    border-radius: 15px;
    padding: 15px;
  }

  .breadcrumb-item a {
    color: var(--text-secondary);
    transition: all 0.3s ease;
    position: relative;
    z-index: 5;
  }

  .breadcrumb-item a:hover {
    color: #6e8efb;
    text-decoration: none;
  }

  /* è´­ç‰©è½¦å•†å“è¡¨æ ¼ */
  .table {
    color: var(--text-primary);
    border-collapse: separate;
    border-spacing: 0 10px;
  }

  .table thead th {
    border-bottom: none;
    padding: 15px 10px;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .table tbody tr {
    background: var(--card-bg);
    margin-bottom: 10px;
    border-radius: 15px;
    box-shadow: 4px 4px 8px var(--shadow-color-dark),
      -4px -4px 8px var(--shadow-color-light);
    transition: all 0.3s ease;
  }

  .table tbody tr:hover {
    transform: translateY(-3px);
    box-shadow: 6px 6px 12px var(--shadow-color-dark),
      -6px -6px 12px var(--shadow-color-light);
  }

  .table tbody td {
    border: none;
    padding: 15px 10px;
    vertical-align: middle;
  }

  /* è´­ç‰©è½¦å•†å“è¡¨æ ¼ - æ–°æ‹Ÿæ€é£æ ¼ */
  .cart-table-container {
    padding: 10px;
  }

  .cart-table {
    color: var(--text-primary);
    border-collapse: separate;
    border-spacing: 0 15px;
    margin-bottom: 0;
  }

  .cart-header {
    background: var(--primary-gradient);
    border-radius: 15px;
  }

  .cart-header th {
    border: none !important;
    padding: 15px;
    color: white !important;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
  }

  .cart-header th:first-child {
    border-top-left-radius: 15px;
    border-bottom-left-radius: 15px;
  }

  .cart-header th:last-child {
    border-top-right-radius: 15px;
    border-bottom-right-radius: 15px;
  }

  .neomorphic-item {
    background: var(--card-bg);
    margin-bottom: 15px;
    border-radius: 15px;
    box-shadow: 5px 5px 10px var(--shadow-color-dark),
      -5px -5px 10px var(--shadow-color-light);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .neomorphic-item:hover {
    transform: translateY(-5px);
    box-shadow: 8px 8px 15px var(--shadow-color-dark),
      -8px -8px 15px var(--shadow-color-light);
  }

  .neomorphic-item td {
    border: none !important;
    padding: 15px;
    vertical-align: middle;
  }

  .neomorphic-item td:first-child {
    border-top-left-radius: 15px;
    border-bottom-left-radius: 15px;
  }

  .neomorphic-item td:last-child {
    border-top-right-radius: 15px;
    border-bottom-right-radius: 15px;
  }

  /* å•†å“å›¾ç‰‡å®¹å™¨ */
  .cart-img-container {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    box-shadow: 4px 4px 8px var(--shadow-color-dark),
      -4px -4px 8px var(--shadow-color-light);
    transition: all 0.3s ease;
  }

  .cart-img-container:hover {
    transform: scale(1.05);
    box-shadow: 5px 5px 10px var(--shadow-color-dark),
      -5px -5px 10px var(--shadow-color-light);
  }

  .cart-product-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: all 0.3s ease;
  }

  /* å•†å“åç§° */
  .cart-product-name {
    color: var(--text-primary);
    text-decoration: none !important;
    transition: all 0.3s ease;
    font-weight: 600;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .cart-product-name:hover {
    transform: translateX(5px);
    text-shadow: 0 0 10px rgba(110, 142, 251, 0.4);
  }

  /* å•†å“ä»·æ ¼ */
  .gradient-price {
    font-weight: 700;
    font-size: 1.1rem;
    background: var(--secondary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .gradient-total-price {
    font-weight: 700;
    font-size: 1.5rem;
    color: #966edc;
  }

  /* æ•°é‡æ§åˆ¶ */
  .quantity-control {
    display: flex;
    align-items: center;
    max-width: 120px;
    background: var(--card-bg);
    border-radius: 50px;
    box-shadow: inset 3px 3px 5px var(--shadow-color-dark),
      inset -3px -3px 5px var(--shadow-color-light);
    overflow: hidden;
    padding: 2px;
  }

  .quantity-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 1.2rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    z-index: 5;
    box-shadow: 3px 3px 6px var(--shadow-color-dark),
      -3px -3px 6px var(--shadow-color-light);
  }

  .quantity-btn:hover {
    color: white;
    background: var(--primary-gradient);
    transform: scale(1.1);
  }

  .quantity-btn:active {
    transform: scale(0.95);
    box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1),
      inset -2px -2px 5px rgba(255, 255, 255, 0.05);
  }

  .quantity-input {
    flex: 1;
    border: none;
    background: transparent;
    text-align: center;
    color: var(--text-primary);
    font-weight: 700;
    padding: 5px;
    width: 40px;
    font-size: 1rem;
  }

  .quantity-input:focus {
    outline: none;
    color: #6e8efb;
  }

  /* æŒ‰é’®æ ·å¼ */
  .btn-delete {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--card-bg);
    color: #ff6b6b;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 4px 4px 8px var(--shadow-color-dark),
      -4px -4px 8px var(--shadow-color-light);
    transition: all 0.3s ease;
    position: relative;
    z-index: 5;
    font-weight: bold;
  }

  .btn-delete:hover {
    background: linear-gradient(135deg, #ff6b6b, #f53844);
    color: white;
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 0 15px rgba(255, 107, 107, 0.6);
  }

  .btn-delete:active {
    transform: scale(0.95);
    box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1),
      inset -2px -2px 5px rgba(255, 255, 255, 0.05);
  }

  .delete-icon {
    font-size: 1.8rem;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .btn-outline-danger {
    background: transparent;
    border: 1px solid rgba(255, 107, 107, 0.5);
    color: #ff6b6b;
  }

  .btn-outline-danger:hover {
    background: linear-gradient(135deg, #ff6b6b, #f53844);
    color: white;
    border-color: transparent;
  }

  /* ç©ºè´­ç‰©è½¦çŠ¶æ€ */
  .empty-state {
    padding: 40px 0;
  }

  .empty-icon {
    font-size: 4rem;
    display: block;
    margin-bottom: 15px;
  }

  /* æ€»é‡‘é¢æ˜¾ç¤º */
  .total-amount {
    font-weight: 600;
    color: var(--text-primary);
  }

  /* ç¡®ä¿æ‰€æœ‰æŒ‰é’®å¯ç‚¹å‡» */
  button,
  .neomorphic-btn,
  .quantity-btn,
  .btn-delete {
    position: relative;
    z-index: 5;
  }

  /* ç»“ç®—åŒºåŸŸæ ·å¼ */
  .checkout-area {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 5px 5px 10px var(--shadow-color-dark),
      -5px -5px 10px var(--shadow-color-light);
  }

  .checkout-total {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  .checkout-btn {
    padding: 12px 30px;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #52b788, #28a745);
    box-shadow: 5px 5px 10px var(--shadow-color-dark),
      -5px -5px 10px var(--shadow-color-light);
    transition: all 0.3s ease;
  }

  .checkout-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(40, 167, 69, 0.4);
  }

  .checkout-icon,
  .trash-icon {
    margin-right: 8px;
    font-size: 1.2rem;
  }
</style>
{/block} {block name="js"}
<script>
  $(function () {
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    $("#selectAll").change(function () {
      var isChecked = $(this).prop("checked");
      $(".item-select").prop("checked", isChecked);

      // æ›´æ–°æ¯ä¸ªå•†å“çš„é€‰ä¸­çŠ¶æ€
      $(".cart-item").each(function () {
        var cartId = $(this).data("id");
        updateSelected(cartId, isChecked);
      });

      // é‡æ–°è®¡ç®—æ€»é‡‘é¢
      calculateTotal();
    });

    // å•ä¸ªå•†å“é€‰ä¸­çŠ¶æ€å˜åŒ–
    $(".item-select").change(function () {
      var cartId = $(this).closest(".cart-item").data("id");
      var isChecked = $(this).prop("checked");

      // æ›´æ–°å•†å“é€‰ä¸­çŠ¶æ€
      updateSelected(cartId, isChecked);

      // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€‰ä¸­
      checkSelectAll();

      // é‡æ–°è®¡ç®—æ€»é‡‘é¢
      calculateTotal();
    });

    // å‡å°‘æ•°é‡
    $(".decrease").click(function () {
      var $row = $(this).closest(".cart-item");
      var $quantity = $row.find(".quantity-input");
      var quantity = parseInt($quantity.val());

      if (quantity > 1) {
        $quantity.val(quantity - 1);
        updateQuantity($row, quantity - 1);
      }
    });

    // å¢åŠ æ•°é‡
    $(".increase").click(function () {
      var $row = $(this).closest(".cart-item");
      var $quantity = $row.find(".quantity-input");
      var quantity = parseInt($quantity.val());
      var max = parseInt($quantity.attr("max"));

      if (quantity < max) {
        $quantity.val(quantity + 1);
        updateQuantity($row, quantity + 1);
      }
    });

    // æ‰‹åŠ¨è¾“å…¥æ•°é‡
    $(".quantity-input").change(function () {
      var $row = $(this).closest(".cart-item");
      var quantity = parseInt($(this).val());
      var max = parseInt($(this).attr("max"));

      if (quantity < 1) {
        $(this).val(1);
        quantity = 1;
      } else if (quantity > max) {
        $(this).val(max);
        quantity = max;
      }

      updateQuantity($row, quantity);
    });

    // åˆ é™¤å•†å“
    $(".remove-item").click(function () {
      var $row = $(this).closest(".cart-item");
      var cartId = $row.data("id");

      if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ")) {
        $.ajax({
          url: "/cart/remove",
          type: "POST",
          data: { cart_id: cartId },
          dataType: "json",
          success: function (res) {
            if (res.code === 1) {
              $row.remove();
              calculateTotal();

              // å¦‚æœè´­ç‰©è½¦ä¸ºç©ºï¼Œåˆ·æ–°é¡µé¢
              if ($(".cart-item").length === 0) {
                location.reload();
              }
            } else {
              alert(res.msg);
            }
          },
          error: function () {
            alert("æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
          },
        });
      }
    });

    // æ¸…ç©ºè´­ç‰©è½¦
    $("#clearCart").click(function () {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ")) {
        $.ajax({
          url: "/cart/clear",
          type: "POST",
          dataType: "json",
          success: function (res) {
            if (res.code === 1) {
              location.reload();
            } else {
              alert(res.msg);
            }
          },
          error: function () {
            alert("æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
          },
        });
      }
    });

    // ç»“ç®—
    $("#checkout").click(function () {
      // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†å•†å“
      var hasSelected = false;
      $(".item-select").each(function () {
        if ($(this).prop("checked")) {
          hasSelected = true;
          return false;
        }
      });

      if (!hasSelected) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•†å“");
        return;
      }

      // è·³è½¬åˆ°ç»“ç®—é¡µé¢
      window.location.href = "/order/create";
    });

    // æ›´æ–°å•†å“é€‰ä¸­çŠ¶æ€
    function updateSelected(cartId, isSelected) {
      $.ajax({
        url: "/cart/updateSelected",
        type: "POST",
        data: {
          cart_id: cartId,
          selected: isSelected ? 1 : 0,
        },
        dataType: "json",
      });
    }

    // æ›´æ–°å•†å“æ•°é‡
    function updateQuantity($row, quantity) {
      try {
        var cartId = $row.data("id");
        var price = parseFloat($row.find(".price").text().replace("ï¿¥", ""));

        // æ›´æ–°å°è®¡é‡‘é¢
        $row.find(".subtotal").text("ï¿¥" + (price * quantity).toFixed(2));

        // ç«‹å³é‡æ–°è®¡ç®—æ€»é‡‘é¢ï¼Œä¸ç­‰å¾…AJAXå“åº”
        calculateTotal();

        // å‘é€AJAXè¯·æ±‚æ›´æ–°æ•°é‡
        $.ajax({
          url: "/cart/updateQuantity",
          type: "POST",
          data: {
            cart_id: cartId,
            quantity: quantity,
          },
          dataType: "json",
          success: function (res) {
            if (res.code !== 1) {
              alert(res.msg);
            }
          },
          error: function (xhr, status, error) {
            console.log("AJAXé”™è¯¯:", status, error);
            console.log("å“åº”æ–‡æœ¬:", xhr.responseText);
          },
        });
      } catch (e) {
        console.error("æ›´æ–°æ•°é‡å‡ºé”™:", e);
      }
    }

    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€‰ä¸­
    function checkSelectAll() {
      try {
        var allChecked = true;
        $(".item-select").each(function () {
          if (!$(this).prop("checked")) {
            allChecked = false;
            return false;
          }
        });

        var $selectAll = $("#selectAll");
        if ($selectAll.length) {
          $selectAll.prop("checked", allChecked);
        }
      } catch (e) {
        console.error("æ£€æŸ¥å…¨é€‰çŠ¶æ€å‡ºé”™:", e);
      }
    }

    // è®¡ç®—æ€»é‡‘é¢
    function calculateTotal() {
      try {
        var total = 0;
        $(".cart-item").each(function () {
          if ($(this).find(".item-select").prop("checked")) {
            var subtotal = parseFloat(
              $(this).find(".subtotal").text().replace("ï¿¥", "")
            );
            total += subtotal;
          }
        });

        var $totalAmount = $("#totalAmount");
        if ($totalAmount.length) {
          $totalAmount.text("ï¿¥" + total.toFixed(2));
        } else {
          console.warn("æœªæ‰¾åˆ°æ€»é‡‘é¢å…ƒç´  #totalAmount");
        }
      } catch (e) {
        console.error("è®¡ç®—æ€»é‡‘é¢å‡ºé”™:", e);
      }
    }
  });
</script>
{/block}
