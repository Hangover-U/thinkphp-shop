{extend name="layout/base" /} {block name="title"}{$product.name} -
åœ¨çº¿è´­ç‰©ç³»ç»Ÿ{/block} {block name="content"}
<div class="container">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb p-3 neomorphic-card mb-4">
      <li class="breadcrumb-item">
        <a href="/" class="text-decoration-none">é¦–é¡µ</a>
      </li>
      <li class="breadcrumb-item">
        <a href="/category/{$product.category_id}" class="text-decoration-none"
          >{$product.category.name}</a
        >
      </li>
      <li class="breadcrumb-item active gradient-text" aria-current="page">
        {$product.name}
      </li>
    </ol>
  </nav>

  <div class="row mb-5">
    <!-- å•†å“å›¾ç‰‡ -->
    <div class="col-md-5">
      <div class="neomorphic-card product-detail-img-container gradient-border">
        <div
          class="product-detail-img-wrapper"
          data-category="{$product.category_id < 7 ? 'electronics' : 'motorcycle'}"
        >
          <img
            src="{$product.image}"
            class="product-detail-img"
            alt="{$product.name}"
            id="productDetailImage"
          />
          {if $product.is_recommend}
          <span class="product-badge badge bg-danger">æ¨è</span>
          {/if}
          <!-- å›¾ç‰‡æ”¾å¤§é•œæ•ˆæœ -->
          <div class="img-magnifier-glass" id="magnifierGlass">
            <div class="img-magnifier-cross-v"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å•†å“ä¿¡æ¯ -->
    <div class="col-md-7">
      <div class="neomorphic-card p-4 h-100 d-flex flex-column">
        <h2 class="mb-4 gradient-heading">{$product.name}</h2>
        <div class="mb-4">
          <span class="product-price">ï¿¥{$product.price}</span>
        </div>

        <div class="product-info mb-4">
          <div class="info-item">
            <span class="info-label">å‚å•†ï¼š</span>
            <span class="info-value">{$product.manufacturer}</span>
          </div>
          <div class="info-item">
            <span class="info-label">åº“å­˜ï¼š</span>
            <span class="info-value">{$product.stock}ä»¶</span>
          </div>
          <div class="info-item">
            <span class="info-label">é”€é‡ï¼š</span>
            <span class="info-value">{$product.sales}ä»¶</span>
          </div>
        </div>

        <form id="addToCartForm" class="mt-auto mb-0">
          <input type="hidden" name="product_id" value="{$product.id}" />
          <div class="mb-4">
            <label for="quantity" class="form-label mb-2">è´­ä¹°æ•°é‡</label>
            <div class="quantity-selector">
              <button type="button" class="quantity-btn" id="decreaseQuantity">
                <span>-</span>
              </button>
              <input
                type="number"
                class="form-control quantity-input"
                id="quantity"
                name="quantity"
                value="1"
                min="1"
                max="{$product.stock}"
              />
              <button type="button" class="quantity-btn" id="increaseQuantity">
                <span>+</span>
              </button>
            </div>
          </div>
          <div class="action-buttons">
            <button type="submit" class="neomorphic-btn btn-cart">
              <i class="cart-icon">ğŸ›’</i> åŠ å…¥è´­ç‰©è½¦
            </button>
            <button type="button" class="neomorphic-btn btn-buy" id="buyNow">
              ç«‹å³è´­ä¹°
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- å•†å“è¯¦æƒ… -->
  <div class="neomorphic-card mb-5 gradient-border">
    <div class="card-header p-3">
      <h4 class="mb-0 gradient-heading">å•†å“è¯¦æƒ…</h4>
      <div class="header-line"></div>
    </div>
    <div class="card-body p-4">
      <p class="product-description">{$product.description}</p>
    </div>
  </div>

  <!-- ç›¸å…³å•†å“ -->
  {if !empty($relatedProducts)}
  <div class="mb-5">
    <h3 class="gradient-heading mb-4">ç›¸å…³å•†å“</h3>
    <div class="row">
      {foreach $relatedProducts as $relatedProduct}
      <div class="col-6 col-md-3 mb-4">
        <div
          class="product-item h-100 position-relative gradient-border"
          data-category="{$relatedProduct.category_id < 7 ? 'electronics' : 'motorcycle'}"
        >
          <div class="product-img-container">
            <img
              src="{$relatedProduct.image}"
              class="product-img"
              alt="{$relatedProduct.name}"
            />
            {if $relatedProduct.is_recommend}
            <span class="product-badge badge bg-danger">æ¨è</span>
            {/if}
          </div>
          <div class="product-info p-3">
            <h5 class="product-title">{$relatedProduct.name}</h5>
            <p class="price">ï¿¥{$relatedProduct.price}</p>
            <div class="text-center mt-3">
              <a href="/product/{$relatedProduct.id}" class="neomorphic-btn"
                >æŸ¥çœ‹è¯¦æƒ…</a
              >
            </div>
          </div>
        </div>
      </div>
      {/foreach}
    </div>
  </div>
  {/if}
</div>
{/block} {block name="css"}
<style>
  /* æ¸å˜æ ‡é¢˜ */
  .gradient-heading {
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* æ¸å˜æ–‡å­— */
  .gradient-text {
    font-weight: 600;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* å•†å“ä»·æ ¼ */
  .product-price {
    font-size: 2rem;
    font-weight: 700;
    background: var(--secondary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
  }

  /* é¦–é¡µå¡ç‰‡å¤´éƒ¨çº¿æ¡ */
  .header-line {
    height: 3px;
    background: var(--accent-gradient);
    margin-top: 10px;
    border-radius: 3px;
  }

  /* é¦–é¡µé¢åŒ…å±‘ */
  .breadcrumb {
    border-radius: 15px;
    padding: 15px;
  }

  .breadcrumb-item a {
    color: var(--text-secondary);
    transition: all 0.3s ease;
  }

  .breadcrumb-item a:hover {
    color: #6e8efb;
    text-decoration: none;
  }

  /* å•†å“ä¿¡æ¯é¡¹ */
  .info-item {
    display: flex;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 12px;
    background: var(--card-bg);
    box-shadow: inset 3px 3px 5px var(--shadow-color-dark),
      inset -3px -3px 5px var(--shadow-color-light);
  }

  .info-label {
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 60px;
  }

  .info-value {
    color: var(--text-primary);
  }

  /* æ•°é‡é€‰æ‹©å™¨ */
  .quantity-selector {
    display: flex;
    align-items: center;
    width: 180px;
    margin-bottom: 10px;
    border-radius: 50px;
    background: var(--card-bg);
    padding: 5px;
    box-shadow: inset 3px 3px 5px var(--shadow-color-dark),
      inset -3px -3px 5px var(--shadow-color-light);
  }

  .quantity-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--card-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
    box-shadow: 3px 3px 6px var(--shadow-color-dark),
      -3px -3px 6px var(--shadow-color-light);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quantity-btn:hover {
    color: #6e8efb;
  }

  .quantity-btn:active {
    box-shadow: inset 2px 2px 4px var(--shadow-color-dark),
      inset -2px -2px 4px var(--shadow-color-light);
  }

  .quantity-input {
    flex: 1;
    border: none;
    background: transparent;
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
    padding: 0;
    margin: 0 10px;
    box-shadow: none;
  }

  .quantity-input:focus {
    background: transparent;
    box-shadow: none;
  }

  /* æ“ä½œæŒ‰é’® */
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }

  .btn-cart {
    background: linear-gradient(135deg, #ffa600, #ff7b00);
    flex: 1;
  }

  .cart-icon {
    margin-right: 5px;
  }

  .btn-buy {
    background: var(--accent-gradient);
    flex: 1;
  }

  /* å•†å“æè¿° */
  .product-description {
    line-height: 1.8;
    color: var(--text-primary);
  }
</style>
{/block} {block name="js"}
<script>
  $(function () {
    // è·å–Cookieå‡½æ•°
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    }

    // æ£€æŸ¥æ˜¯å¦ç™»å½•
    function checkLogin() {
      return getCookie("user_id") !== null && getCookie("is_login") !== null;
    }

    // å•†å“å›¾ç‰‡æ”¾å¤§é•œæ•ˆæœ
    $(function () {
      const container = $(".product-detail-img-wrapper");
      const img = $(".product-detail-img");
      const glass = $("#magnifierGlass");

      // é…ç½®
      const zoom = 4; // å¢åŠ æ”¾å¤§å€æ•°

      // åˆå§‹åŒ–
      glass.hide();

      // é¼ æ ‡è¿›å…¥äº‹ä»¶
      container.on("mouseenter", function () {
        // æ˜¾ç¤ºæ”¾å¤§é•œ
        glass.show();

        // æ•´ä½“å›¾ç‰‡è½»å¾®æ”¾å¤§æ•ˆæœ
        img.css({
          transform: "scale(1.15)",
          transition: "transform 0.3s ease",
        });
      });

      // ç§»åŠ¨äº‹ä»¶
      container.on("mousemove", function (e) {
        // å®¹å™¨ä½ç½®å’Œå°ºå¯¸
        const rect = container[0].getBoundingClientRect();
        const cw = container.width();
        const ch = container.height();

        // é¼ æ ‡ç›¸å¯¹ä½ç½®
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // æ”¾å¤§é•œå°ºå¯¸å’Œä½ç½®ï¼ˆä¸­å¿ƒåœ¨é¼ æ ‡å¤„ï¼‰
        const gw = glass.width();
        const gh = glass.height();

        // æ”¾å¤§é•œä½ç½®ï¼ˆç¡®ä¿ä¸è¶…å‡ºå®¹å™¨ï¼‰
        let glassLeft = Math.min(Math.max(0, x - gw / 2), cw - gw);
        let glassTop = Math.min(Math.max(0, y - gh / 2), ch - gh);

        // è®¾ç½®æ”¾å¤§é•œä½ç½®
        glass.css({
          left: glassLeft + "px",
          top: glassTop + "px",
        });

        // å›¾ç‰‡æº
        const imgSrc = img.attr("src");

        // è®¡ç®—èƒŒæ™¯å°ºå¯¸ï¼ˆæ”¾å¤§åçš„å°ºå¯¸ï¼‰
        const bgW = cw * zoom;
        const bgH = ch * zoom;

        // è®¡ç®—èƒŒæ™¯ä½ç½®
        const bgX = Math.round(x * zoom - gw / 2);
        const bgY = Math.round(y * zoom - gh / 2);

        // è®¾ç½®èƒŒæ™¯
        glass.css({
          backgroundImage: `url(${imgSrc})`,
          backgroundSize: `${bgW}px ${bgH}px`,
          backgroundPosition: `-${bgX}px -${bgY}px`,
        });

        // åŠ¨æ€è°ƒæ•´å›¾ç‰‡å˜æ¢ä¸­å¿ƒç‚¹ï¼Œä½¿å›¾ç‰‡æ”¾å¤§æ•ˆæœè·Ÿéšé¼ æ ‡
        const transformOriginX = (x / cw) * 100;
        const transformOriginY = (y / ch) * 100;
        img.css(
          "transform-origin",
          `${transformOriginX}% ${transformOriginY}%`
        );
      });

      // ç¦»å¼€äº‹ä»¶
      container.on("mouseleave", function () {
        glass.hide();

        // æ¢å¤åŸå§‹å¤§å°
        img.css({
          transform: "scale(1)",
          transition: "transform 0.3s ease",
        });
      });
    });

    // å‡å°‘æ•°é‡
    $("#decreaseQuantity").click(function () {
      var quantity = parseInt($("#quantity").val());
      if (quantity > 1) {
        $("#quantity").val(quantity - 1);
      }
    });

    // å¢åŠ æ•°é‡
    $("#increaseQuantity").click(function () {
      var quantity = parseInt($("#quantity").val());
      var max = parseInt($("#quantity").attr("max"));
      if (quantity < max) {
        $("#quantity").val(quantity + 1);
      }
    });

    // æ‰‹åŠ¨è¾“å…¥æ•°é‡éªŒè¯
    $("#quantity").change(function () {
      var quantity = parseInt($(this).val());
      var max = parseInt($(this).attr("max"));

      if (isNaN(quantity) || quantity < 1) {
        $(this).val(1);
      } else if (quantity > max) {
        $(this).val(max);
        alert("å·²è®¾ç½®ä¸ºæœ€å¤§å¯è´­ä¹°æ•°é‡ï¼š" + max);
      }
    });

    // åŠ å…¥è´­ç‰©è½¦
    $("#addToCartForm").submit(function (e) {
      e.preventDefault();

      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      if (!checkLogin()) {
        if (confirm("è¯·å…ˆç™»å½•ï¼Œæ˜¯å¦è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Ÿ")) {
          window.location.href =
            "/user/login?redirect=" + encodeURIComponent(window.location.href);
        }
        return;
      }

      $.ajax({
        url: "/cart/add",
        type: "POST",
        data: $(this).serialize(),
        dataType: "json",
        success: function (res) {
          if (res.code === 1) {
            // æˆåŠŸåŠ å…¥è´­ç‰©è½¦
            alert(res.msg + "ï¼Œå¯ä»¥åœ¨è´­ç‰©è½¦ä¸­æŸ¥çœ‹");
          } else {
            if (res.msg === "è¯·å…ˆç™»å½•") {
              if (confirm("è¯·å…ˆç™»å½•ï¼Œæ˜¯å¦è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Ÿ")) {
                window.location.href =
                  "/user/login?redirect=" +
                  encodeURIComponent(window.location.href);
              }
            } else {
              alert(res.msg);
            }
          }
        },
        error: function (xhr, status, error) {
          console.error("æ·»åŠ è´­ç‰©è½¦é”™è¯¯:", status, error);
          alert("æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
        },
      });
    });

    // ç«‹å³è´­ä¹°
    $("#buyNow").click(function () {
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      if (!checkLogin()) {
        if (confirm("è¯·å…ˆç™»å½•ï¼Œæ˜¯å¦è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Ÿ")) {
          window.location.href =
            "/user/login?redirect=" + encodeURIComponent(window.location.href);
        }
        return;
      }

      // å…ˆåŠ å…¥è´­ç‰©è½¦ï¼Œç„¶åè·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢
      $.ajax({
        url: "/cart/add",
        type: "POST",
        data: $("#addToCartForm").serialize(),
        dataType: "json",
        success: function (res) {
          if (res.code === 1) {
            // æˆåŠŸåŠ å…¥è´­ç‰©è½¦åç›´æ¥è·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢
            window.location.href = "/cart";
          } else {
            if (res.msg === "è¯·å…ˆç™»å½•") {
              if (confirm("è¯·å…ˆç™»å½•ï¼Œæ˜¯å¦è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Ÿ")) {
                window.location.href =
                  "/user/login?redirect=" +
                  encodeURIComponent(window.location.href);
              }
            } else {
              alert(res.msg);
            }
          }
        },
        error: function (xhr, status, error) {
          console.error("ç«‹å³è´­ä¹°é”™è¯¯:", status, error);
          alert("æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
        },
      });
    });
  });
</script>
{/block}
